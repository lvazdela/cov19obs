---
#title: "Untitled"
#author: "Luis G. Vazquez de Lara Cisneros."
#date: "15/1/2021"
#site: bookdown::bookdown_site
output:
  bookdown::word_document2:
    reference_docx: templateword3.docx
bibliography: references.bib
csl: archives-of-medical-research.csl
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
#libraries:
library(tidyverse)
library(lubridate)
#library(scales)
library(flextable) #para Word es mejor que kableExtra en tablas
library(officer)
library(officedown)
#library(kableExtra) #para las figuras
library(knitr) # para estar checando errores (correr chunks antes de compilar)
library(binom)
library(gridExtra)
library(survival)
library(survminer)
#External data
load('Rdata/bdcoving.rda')
load('Rdata/labosvalref.rda') #Base de laboratorios
load('Rdata/bdcovdiario.rda')
load('Rdata/dfmexhosp.rda')

```

# Title {.unnumbered}

Presenting Characteristics, Clinical Features and Outcomes of Hospitalized Patients with Covid-19. Experience in a Tertiary Level Mexican Hospital.

# Summary {.unnumbered}

Background.

Covid-19 is a novel coronavirus disease with a broad clinical spectrum that has spread globally. Currently there is no standardized treatment, and the outcome varies greatly among countries. Accordingly, regional information is needed to inform the decision making for health care providers.

Aim of the study.

Describe the presenting characteristics, clinical course and outcomes of hospitalized patients in a tertiary Mexican hospital.

Methods.

Retrospective cohort study of 619 consecutive patients admitted to the Hospital de Especialidades Manuel Ávila Camacho, IMSS, between April 3rd and October 17th, 2020 with a confirmed diagnosis of Covid-19 by RT-PCR. The data included demographics, socioeconomic data, level of education, clinical data of the entire admission, and the outcome at the moment of discharge.

Results.

All patients had pneumonia. The median age was 55 years, 91% had at least one comorbidity and the most frequent were: overweight/obesity (78.2%), hypertension (35.2%) and diabetes mellitus (20.5%). Fever, malaise and cough were the most common presenting symptoms. D-dimer, fibrinogen, glucose calcium, blood gases and organ damage markers were the most frequent laboratory test values altered. Around 35.1% of patients required invasive ventilation. The overall mortality was 31% and the poorest outcome was seen in those mechanically ventilated outside ICU.

Conclusion.

Overweight, obesity, hypertension and diabetes mellitus were the most common comorbid condtions. Fever, malaise and cough were the most common initial symptoms. Monocytopenia rather than lymphopenia was seen in this cohort. The highest mortality rate was seen in patients on mechanical ventilation outside UCI.


Key words: Covid-19; hospitalization; viral pneumonia; mortality; cohort studies; retrospective studies.

# Introduction {.unnumbered}

Covid-19 is a disease caused by a novel virus named *severe acute respiratory syndrome coronavirus 2* (SARS-Cov-2). It belongs to the subgenus Sarbecovirus, genus Betacoronavirus, subfamily Orthocoronavirinae and family Coronaviridae. The periphery of coronaviruses resembles the solar corona in negative-stained electron microscopy, hence its name [@artika2020]. The disease was first identified in the city of Wuhan, China, and has spread globally, presenting a severe threat to global health. The clinical presentation is heterogeneous, ranging from an asymptomatic disease to a life-threatening condition with respiratory failure. At present, specific therapies are lacking. In Mexico, the first cases were reported in February 2020, with pandemic disease levels peaking during July and August, starting to decrease during the following months. However, as of January 2020, the Mexican health system faced a second wave with more lethality than the first one . During this time *The Mexican Institute of Social Security* (IMSS, after the initials in Spanish), carried the biggest burden of public health care and the highest mortality of patients hospitalized with Covid-19 [@sancheztalanquer2020].

Because the mortality of hospitalized patients with this disease varies from country to country, it is important for the clinician to have data describing the features and behavior of this disease in different clinical settings. The aim of this study is to describe the demographics, presenting characterstics, clinical course and outcomes of hospitalized patients from a Mexican hospital dedicated to patients affected with Covid-19.

# Methods {.unnumbered}

```{r muestra, message=FALSE, warning=FALSE}
#load('Rdata/bdcoving.rda')
bdcoving2 <- bdcoving %>%
  filter(motivoegre %in% c(2,3), rescov1 == 1) %>%
  select(edad, fecha, imc)

totmuestra <- dim(bdcoving2)[1]
fechaini <- min(bdcoving2$fecha)
fechafin <- max(bdcoving2$fecha)
# covpos <- sum(bdcoving$rescov1 == 1)
# noegre <- sum(!(bdcoving$motivoegre %in% c(2,3)))
#totmuestra <- covpos - noegre

```

This is a retrospective cohort study conducted at the *Hospital de Especialidades de Puebla, IMSS*, Mexico. This site is a 315 bed multi-specialty hospital and a referral center for patients from the states of Puebla, Tlaxcala and Oaxaca. In March 2020 it was converted to a hybrid Covid-19 hospital. Data was collected from the charts of patients admitted between `r month.name[month(fechaini)]` `r day(fechaini)`^rd^ and `r month.name[month(fechafin)]` `r day(fechafin)`^th^ `r year(fechafin)` with a clinical diagnosis of Covid-19 and a positive SARS-Cov-2 RT-PCR nasopharyngeal swab. Patients transferred to other facilities were not included. This study was approved by the *Hospital de Especialidades* institutional review board (No. R-2020-785-126) as a minimal-risk research and informed consent was waived.

The data gathered included demographics, baseline comorbidities, medications, vital signs on admission and initial laboratory test. Prescribed medications and laboratory results were also analyzed for the duration of the admission. Finally, pertinent clinical outcomes were recorded. The Systematic COronary Risk Evaluation (SCORE) index was calculated, which gives the risk of developing fatal cardiovascular disease at 10 years. This score is endorsed by the European Society of Cardiology for high-risk patients and was used because of the high prevalence of cardiovascular risk factors in the Mexican population. The score considers age from 40 years, gender, systolic blood pressure, smoking, and total cholesterol level [@conroy2003a; @versteylen2011]. Socioeconomic level was classified in in high, medium-high, medium-low and low. For this, an *ad-hoc* scale was used obtaining a profile of the household which considered the educational level, current job position and the company where he or she works.

The statistical analysis was performed with the R programming language [@rcoreteam2020] and RStudio [@rstudioteam2021], with the packages **tidyverse** [@wickham2019] and **lubridate** [@grolemund2011]. When appropriate, 95% confidence intervals were calculated with the **binom** package [@dorai-raj2014]. Unless otherwise stated, the results are reported as the median, the inter-quartile range (IQR), and the range (minum-maximum) of the values.

# Results {.unnumbered}

```{r vartexto}
porsexo <- bdcoving%>%
  filter(motivoegre %in% c(2,3), rescov1 == 1)%>%
  select(sexo)%>%
 pivot_longer(sexo, names_to = 'apps', values_to = 'valor') %>%
  group_by(apps, valor) %>%
  na.omit %>%
  summarise(n = n()) %>%
  mutate(frec = round(n/sum(n)*100, 1), total = sum(n))

ocuptexto <- bdcoving%>%
  filter(motivoegre %in% c(2,3),rescov1 == 1, ocupacion != 7)%>%
  select(ocupacion)%>%
  mutate(ocupacion = case_when(
    ocupacion == 1 ~ 'Personal sanitario',
    ocupacion == 2 ~ 'Trabajo de oficina',
    ocupacion == 3 ~ 'Trabajo al aire libre',
    ocupacion == 4 ~ 'Trabajo en espacio pÃƒÂƒÃ‚ÂƒÃƒÂ‚Ã‚ÂƒÃƒÂƒÃ‚Â‚ÃƒÂ‚Ã‚Âºblico',
    ocupacion == 5 ~ 'Trabajo en casa',
    ocupacion == 6 ~ 'No trabaja'
  ))%>%
   pivot_longer(ocupacion, names_to = 'apps', values_to = 'valor') %>%
  group_by(apps, valor) %>%
  na.omit %>%
  summarise(n = n()) %>%
  mutate(frec = round(n/sum(n)*100, 1), total = sum(n))


escoltexto <- bdcoving%>%
  filter(motivoegre %in% c(2,3),rescov1 == 1)%>%
  select(escolaridad)%>%
  mutate(escolaridad = case_when(
    escolaridad == 1 ~ 'Analfabeta',
    escolaridad == 2 ~ 'Primaria',
    escolaridad == 3 ~ 'Secundaria',
    escolaridad == 4 ~ 'Bachillerato',
    escolaridad == 5 ~ 'Licenciatura',
    escolaridad == 6 ~ 'Posgrado'
  ))%>%
  rename( Escolaridad = escolaridad) %>%
  na.omit %>%
  pivot_longer(Escolaridad, names_to = 'apps', values_to = 'valor') %>%
  group_by(apps, valor) %>%
  summarise(n = n()) %>%
  mutate(frec = round(n/sum(n)*100, 1), total = sum(n))

nivsoctexto <- bdcoving%>%
  filter(motivoegre %in% c(2,3),rescov1 == 1)%>%
  select(nivsoc)%>%
  mutate(nivsoc = case_when(
    nivsoc %in% c(1,2) ~ 'Bajo, medio-bajo',
    nivsoc %in% c(3,4) ~ 'Medio-alto, alto'
  ))%>%
  na.omit %>%
  pivot_longer(nivsoc, names_to = 'apps', values_to = 'valor') %>%
  group_by(apps, valor) %>%
  summarise(n = n()) %>%
  mutate(frec = round(n/sum(n)*100, 1), total = sum(n))

  
```

## Patient characteristics. {.unnumbered}

A total of `r totmuestra` cases were included in the study. Table \@ref(tab:tbvargen) shows the somatometric and sociodemographic variables studied. The median age was `r median(bdcoving2$edad, na.rm = TRUE)` years, 50% of patients were between `r quantile(bdcoving2$edad, 0.25, na.rm = TRUE)` and `r quantile(bdcoving2$edad, 0.75, na.rm = TRUE)` years old. The median of body mass index (BMI) was `r round(median(bdcoving2$imc, na.rm = TRUE),1)` kg/m^2^ with an interquartile range (IQR) between `r round(quantile(bdcoving2$imc, 0.25, na.rm = TRUE),1)` and `r round(quantile(bdcoving2$imc, 0.75, na.rm = TRUE),1)`; `r porsexo$frec[2]`% were male. A total of `r ocuptexto$frec[2]`% were health care workers, while `r ocuptexto$frec[6]`% worked in a public space. Patients who were illiterate comprised `r escoltexto$frec[1]`% of the sample, while only `r escoltexto$frec[4]`% had postgraduate studies. A total of `r nivsoctexto$frec[1]`% had a socioeconomic level considered as medium-low or low.

```{r bdvarnum, include=TRUE, eval=TRUE}
roundcond <- function(x, dec = 1){
  #browser()
  ifelse(trunc(x) == 0,
         ifelse(x%%1 < 0.001,
                format(round(x),
                       trim = TRUE),
                format(round(x,2),
                       nsmall = 2,
                       big.mark = ',',
                       trim = TRUE)),
         
         ifelse(x%%1 < 0.001,
                format(round(x),
                       nsmall = 0,
                       big.mark = ',',
                       trim = TRUE),
                format(round(x, dec),
                       nsmall = dec,
                       big.mark = ',',
                       trim = TRUE))         )
}

bdvarnumglob <- bdcoving %>%filter(motivoegre %in% c(2,3) & rescov1 == 1)%>%
  select(edad, peso, talla, imc)%>%
  summarise(across(everything(), list(
    faltan = ~sum(is.na(.x)),
    mediana = ~ roundcond(median(.x, na.rm = TRUE)),
    p25 = ~ roundcond(quantile(.x, 0.25, na.rm = TRUE)),
    p75 = ~ roundcond(quantile(.x, 0.75, na.rm = TRUE)),
    min = ~ roundcond(min(.x, na.rm = TRUE)),
    max = ~ roundcond(max(.x, na.rm = TRUE))
  )))%>%
  pivot_longer(cols = everything(),
               names_sep = '_',
               names_to = c('variable', '.value'))%>%
  mutate(p25 = ifelse(variable == 'imc', as.character(round(as.numeric(p25), 1)), p25),
         p75 = ifelse(variable == 'imc', as.character(round(as.numeric(p75), 1)), p75),
         min = ifelse(variable == 'imc', as.character(round(as.numeric(min), 1)), min),
         max = ifelse(variable == 'imc', as.character(round(as.numeric(max), 1)), max)) %>%
  unite('iqr', c(p25, p75), sep = ' - ') %>%
  unite('range',c(min, max), sep = ' - ' ) %>%
  mutate(variable = case_when(
    variable == 'edad' ~ 'Age',
    variable == 'peso' ~ 'Weight',
    variable == 'talla' ~ 'Height',
    variable == 'imc' ~ 'BMI'
  )) %>%
  mutate(value = paste0(mediana, ', ', '(', iqr, ') ', '[', range, ']')) %>%
  rename(Valor = variable) %>%
  select(Valor, value, faltan)
```

```{r dbvarsocdem, include=TRUE}
frecsexo <- bdcoving%>%
  filter(motivoegre %in% c(2,3), rescov1 == 1)%>%
  select(sexo)%>%
  mutate(sexo = factor(sexo, labels = c('   Female','   Male'))) %>%
 pivot_longer(sexo, names_to = 'apps', values_to = 'valor') %>%
  group_by(apps, valor) %>%
  na.omit %>%
  summarise(n = n()) %>%
  mutate(frec = round(n/sum(n)*100, 1), total = NA)%>%
  arrange(frec)%>%
  rename(Variable = apps,Valor = valor , Cantidad = n, Porcentaje = frec, Total = total)%>%
  mutate (value = paste0(Cantidad, ' (', Porcentaje, ')')) %>%
  select( Valor, value, Total)
  
frecocup <- bdcoving%>%
  filter(motivoegre %in% c(2,3),rescov1 == 1, ocupacion != 7)%>%
  select(ocupacion)%>%
  mutate(ocupacion = case_when(
    ocupacion == 1 ~ '   Health care worker',
    ocupacion == 2 ~ '   Office job',
    ocupacion == 3 ~ '   Outdoor work',
    ocupacion == 4 ~ '   Work in a public area',
    ocupacion == 5 ~ '   Work at home',
    ocupacion == 6 ~ '   Unemployed'
  ))%>%
  pivot_longer(ocupacion, names_to = 'apps', values_to = 'valor') %>%
  group_by(apps, valor) %>%
  na.omit %>%
  summarise(n = n()) %>%
  mutate(frec = round(n/sum(n)*100, 1), total = NA)%>%
  arrange(frec)%>%
  rename(Variable = apps,Valor = valor , Cantidad = n, Porcentaje = frec, Total = total)%>%
  mutate (value = paste0(Cantidad, ' (', Porcentaje, ')')) %>%
  select(Valor, value, Total)

frecescol <- bdcoving%>%
  filter(motivoegre %in% c(2,3),rescov1 == 1)%>%
  select(escolaridad)%>%
  mutate(escolaridad = case_when(
    escolaridad == 1 ~ '   Illiteracy',
    escolaridad == 2 ~ '   Primary school',
    escolaridad == 3 ~ '   Junior high school',
    escolaridad == 4 ~ '   High school',
    escolaridad == 5 ~ '   College',
    escolaridad == 6 ~ '   Postgraduate studies'
  ))%>%
  rename( Escolaridad = escolaridad) %>%
  na.omit %>%
  pivot_longer(Escolaridad, names_to = 'apps', values_to = 'valor') %>%
  group_by(apps, valor) %>%
  summarise(n = n()) %>%
  mutate(frec = round(n/sum(n)*100, 1), total = NA)%>%
  mutate(valor = factor(valor, levels = c('   Illiteracy','   Primary school', '   Junior high school', '   High school', '   College', '   Postgraduate studies'))) %>%
  arrange(valor)%>%
  rename(Variable = apps,Valor = valor , Cantidad = n, Porcentaje = frec, Total = total)%>%
  mutate (value = paste0(Cantidad, ' (', Porcentaje, ')')) %>%
  select(Valor, value, Total)

#Ahora nivel socioeconÃƒÂƒÃ‚ÂƒÃƒÂ‚Ã‚ÂƒÃƒÂƒÃ‚Â‚ÃƒÂ‚Ã‚Â³mico

frecnivsoc <- bdcoving%>%
  filter(motivoegre %in% c(2,3),rescov1 == 1)%>%
  select(nivsoc)%>%
  mutate(nivsoc = case_when(
    nivsoc == 1 ~ '   Low',
    nivsoc == 2 ~ '   Medium-low',
    nivsoc == 3 ~ '   Medium-high',
    nivsoc == 4 ~ '   High'
  ))%>%
  na.omit %>%
   pivot_longer(nivsoc, names_to = 'apps', values_to = 'valor') %>%
  group_by(apps, valor) %>%
  summarise(n = n()) %>%
  mutate(frec = round(n/sum(n)*100, 1), total = NA)%>%
  mutate(valor = factor(valor, levels = c('   Low','   Medium-low','   Medium-high','   High'))) %>% #para que se ordenen de bajo a alto
  arrange(valor)%>%
  rename(Variable = apps,Valor = valor , Cantidad = n, Porcentaje = frec, Total = total)%>%
  mutate (value = paste0(Cantidad, ' (', Porcentaje, ')')) %>%
  select(Valor, value, Total)

#otra manera de unir, para tener una sÃƒÂƒÃ‚ÂƒÃƒÂ‚Ã‚ÂƒÃƒÂƒÃ‚Â‚ÃƒÂ‚Ã‚Â³la tabla de las numÃƒÂƒÃ‚ÂƒÃƒÂ‚Ã‚ÂƒÃƒÂƒÃ‚Â‚ÃƒÂ‚Ã‚Â©ricas y categÃƒÂƒÃ‚ÂƒÃƒÂ‚Ã‚ÂƒÃƒÂƒÃ‚Â‚ÃƒÂ‚Ã‚Â³ricas.

  
bdsexo <- data.frame(Valor = 'Gender', value = '', Total = sum(is.na(bdcoving$sexo)))
bdocup <- data.frame(Valor = 'Occupation', value = '', Total = sum(is.na(bdcoving$ocupacion)) )
bdescol <- data.frame(Valor = 'Schooling', value = '', Total = sum(is.na(bdcoving$escolaridad)) )
bdnivsoc <- data.frame(Valor = 'Socioeconomic level', value = '', Total = sum(is.na(bdcoving$nivsoc)))

dbvarsocdemglob <- bind_rows(bdsexo, frecsexo,
                             bdocup, frecocup,
                             bdescol, frecescol,
                             bdnivsoc, frecnivsoc) %>%
  mutate(faltan = Total) %>%
  select(-c(Variable, Total))



```

```{r ggedad, fig.cap= 'Distribution of the age in the study group'}
# bdcoving %>%
#   ggplot(aes(x = edad)) +
#   theme_classic() +
#   labs(x = 'Age in years',
#        y = 'Number of patients') +
#   geom_histogram(binwidth = 10, color = 'darkolivegreen4',
#                fill = 'darkolivegreen2')

```

```{r dbvargen}

bdsom <- data.frame(Valor = 'Somatic variables:',
                    value = 'Median, (IQR), [range]',
                    faltan = NA)
bdsocd <- data.frame(Valor = 'Sociodemographic variables:',
                     value = 'No. (%)',
                     faltan = NA)
bdvargen <- bind_rows(bdsom, bdvarnumglob, bdsocd, dbvarsocdemglob)

```

```{r tbvargen, include=TRUE}
flextable(bdvargen) %>%
  set_caption(caption = 'Baseline features of the study patients',
              style = 'Table Caption') %>%
  set_header_labels(Valor = 'Variable',
                    value = 'Value',
                    faltan = 'Missing cases') %>%
  #align(j = 2:3, align = 'center', part = 'all') %>%
  align(align = 'center', part = 'header') %>%
  align(j = 3, align = 'center', part = 'body') %>%
  align(i = c(1,6), align = 'center') %>%
  bold(part = 'header') %>%
  bold(i = c(1,6)) %>%
  italic(i = c(1,6)) %>%
  bold( i = c(7,10, 17,24), j = 1) %>%
  #fontsize(i = c(1,6), j = 1, size = 12) %>%
  valign(j = 3, valign = 'top', part = 'body') %>%
  set_table_properties(width = 0.6, layout = 'autofit')
 
```

```{r bdcomorb}
appeng1 <- read_lines('bases-originales/nomappeng.txt')
##creamos sobrepeso y obesidad (app_18, app_19)
bdcoving <- bdcoving %>%
  mutate(app_18 = as.factor(ifelse(imc >= 25 & imc < 30, 1, 2)),
         app_19 = as.factor(ifelse(imc >= 30, 1, 2)))
#aÃƒÂƒÃ‚Â±ado has, porque en la base de excel estÃƒÂƒÃ‚Â¡ separada del conjunto de antecedentes personales patolÃƒÂƒÃ‚Â³gicos (app),
appeng <- c('Hypertension', appeng1, 'Overweight', 'Obesity')
nomappord <- bdcoving%>%select(starts_with('app'))%>%names

#Frecuencia global de antecedentes
frecapp <- bdcoving%>%
  filter(motivoegre %in% c(2,3), rescov1 == 1)%>% 
  select(starts_with('app')) %>%
  mutate(across(everything(), ~ ifelse(is.na(.x), 2, .x))) %>%
  pivot_longer(starts_with('app'), names_to = 'apps', values_to = 'valor')%>%
  group_by(apps, valor) %>%
  mutate(apps = factor(apps, levels = nomappord, labels = appeng),
         valor = factor(valor, levels = c(1,2), labels = c('Si', 'No')))%>%
  summarise(n = n())%>%
  mutate(frec = round(n/sum(n)*100, 1),
         total = sum(n))%>%
  filter(valor == 'Si')%>%
  arrange(desc(frec))
  
porcgordos <- round(((frecapp$n[1] + frecapp$n[2])/totmuestra)*100,1)

#NÃƒÂƒÃ‚Âºmero de comorbilidades asociadas
totapp <- length(nomappord) -1
facanum <- function(x){
  as.numeric(as.character(x))
}

numappglob <- bdcoving %>%
  filter(motivoegre %in% c(2,3) & rescov1 == 1)%>% 
  select(-app_7) %>% #medicaciÃƒÂƒÃ‚ÂƒÃƒÂ‚Ã‚ÂƒÃƒÂƒÃ‚Â‚ÃƒÂ‚Ã‚Â³n empleada no es una comorbilidad
  rowwise()%>%
  mutate(across(starts_with('app'), facanum) ) %>%
  mutate(numapp = (totapp - sum(is.na(c_across(starts_with('app')))))*2 - sum(c_across(starts_with('app')),
                                                                              na.rm = TRUE))%>%
  select(motivoegre, numapp)%>%
  ungroup %>%
  mutate(numapp = factor(numapp)) %>%
  group_by(numapp)%>%
  summarise(n = n()) %>%
  mutate(frec = round(n/sum(n)*100, 1),
         total = sum(n),
         validos = sum(n)- sum(is.na(numapp)))%>%
  select(numapp, n, frec) 
#score index
score <- bdcoving%>%
  filter(motivoegre %in% c(2,3), rescov1 == 1)%>%
  select(score) %>%
  pull
summScore <- summary(score)
```

A total of `r frecapp$n[2]` (`r round(frecapp$frec[2])`%) patients were overweight (BMI more or equal to 25 and less than 30), while `r frecapp$n[1]` (`r round(frecapp$frec[1],1)`%) had obesity (BMI 30 or more). It is worth noting that `r porcgordos`% of patients were overweight or obese. Hypertension was present in `r frecapp$n[3]` patients (`r round(frecapp$frec[3],1)`%). Diabetes mellitus was present in `r frecapp$n[5]` cases (`r round(frecapp$frec[5],1)`%). A total of `r frecapp$n[4]` (`r round(frecapp$frec[4],1)`%) reported chronic medication use. Only `r frecapp$n[18]` (`r round(frecapp$frec[18],1)`%) had a chronic lung disease, and 67 patients (10.8%) were current smokers. The median of the SCORE index was `r summScore[3]`, IQR (`r paste0(summScore[2],'-',summScore[5])`). The maximum number of associated comorbidities in an individual was 8 (one patient); only `r numappglob$n[1]` (`r round(numappglob$frec[1])`%) had no comorbidities; a total of `r sum(numappglob$n[2:4])` (`r round(sum(numappglob$frec[2:4]),1)`%) had either 1, 2 or 3 associated comorbidities. Details of the comorbidities reported are summarised in table 1 and figure 1 of the Supplementary material.

```{r tbapp}
frecapp %>%
    mutate(numporc = paste0(n, ' (', frec, ')')) %>%
  select(apps, numporc) %>%
  filter(apps != 'Use of medication') %>%
  flextable() %>%
    # set_caption(caption = 'Baseline comorbidities.',
    #           style = 'Table Caption') %>%
  set_header_labels(apps = 'Comorbidity',
                    numporc = 'No. (%)') %>%
  align(align = 'center', part = 'header') %>%
  bold(part = 'header') %>%
  set_table_properties(width = 0.6, layout = 'autofit')
```

```{r tbnumapp}
# numappglob %>%
#   mutate(numporc = paste0(n, ' (', frec, ')' )) %>%
#   select(numapp, numporc) %>%
#   flextable() %>%
#     set_caption(caption = 'Number of associated comorbidities.',
#               style = 'Table Caption') %>%
#     set_header_labels(numapp = 'Number of comorbidities',
#                       numporc = 'No. (%)') %>%
#     align(align = 'center', part = 'header') %>%
#     bold(part = 'header') %>%
#     set_table_properties(width = 0.6, layout = 'autofit')
```

```{r fnumapp}
# , fig.cap='Number of associated comorbidities per patient.'
numappglob %>%
  ggplot(aes(x = numapp, y = frec)) +
  labs(x = 'Number of associated comorbidities',
       y = 'Percentage of patients') +
  geom_col(color = 'darkolivegreen4',
           fill = 'darkolivegreen2' )

```

```{r bdstxprev, results='hide'}
txpreveng <- read_lines('bases-originales/nomtxpreveng.txt')
nomtxprevord <- bdcoving%>%select(starts_with('txprev'))%>%names


# solo emplearemos los pacientes con resultado de la prueba Covid

#Frecuencia global de tratamientos previos
frectxprev <- bdcoving%>%
  filter(motivoegre %in% c(2,3) & rescov1 == 1)%>%
  select(starts_with('txprev')) %>%
  pivot_longer(starts_with('txprev'), names_to = 'txprevs', values_to = 'valor')%>%
  group_by(txprevs, valor) %>%
  na.omit %>%
  mutate(txprevs = factor(txprevs, levels = nomtxprevord, labels = txpreveng), 
         valor = factor(valor, levels = c(1,2), labels = c('Si', 'No'))) %>%
  summarise(n = n())%>%
  mutate(frec = round(n/sum(n)*100, 2), total = sum(n)) %>%
  filter(valor == 'Si')%>%
  select(txprevs, n, frec, total ) %>%
  arrange(desc(frec))

#Cantidad de tratamientosacumulados por persona:
facanum <- function(x){
  as.numeric(as.character(x))
}

numtxprevglob <- bdcoving %>%
  filter(motivoegre %in% c(2,3) & rescov1 == 1)%>%
  mutate(across(starts_with('txprev'), facanum) ) %>%
  rowwise()%>%
  mutate(numtxprev = (length(nomtxprevord)-sum(is.na(c_across(starts_with('txprev')))))*2 - sum(c_across(starts_with('txprev')), na.rm = TRUE))%>%
  select(motivoegre, numtxprev) %>%
  ungroup %>%
  mutate(numtxprev = factor(numtxprev))%>%
  group_by(numtxprev)%>%
  summarise(n = n()) %>%
  mutate(frec = round(n/sum(n)*100, 2),
         total = sum(n),
         validos = sum(n)- sum(is.na(numtxprev)))%>%
  select(numtxprev, n, frec, validos)

dosomastx <- round(sum(numtxprevglob$frec[-(1:2)]),1)
polifar <- round(sum(numtxprevglob$frec[6:11]),1)

statntxprev <- bdcoving %>%
  filter(motivoegre %in% c(2,3) & rescov1 == 1)%>%
  mutate(across(starts_with('txprev'), facanum) ) %>%
  rowwise()%>%
  mutate(numtxprev = (length(nomtxprevord)-sum(is.na(c_across(starts_with('txprev')))))*2 - sum(c_across(starts_with('txprev')), na.rm = TRUE))%>%
  select(numtxprev) %>%
  ungroup() %>%
  summarise(mediana = median(numtxprev, na.rm = TRUE ),
            p25 = round(quantile(numtxprev, 0.25, na.rm = TRUE),1),
            p75 = round(quantile(numtxprev, 0.75, na.rm = TRUE),1))


```

The most common drugs prescribed prior to admission were acetaminophen (43.13%) and antibiotics (34.25%). A total of `r round(numtxprevglob$frec[1], 1)`% of the patients had no drugs prescribed prior to admission for Covid-19. In contrast, `r dosomastx`% of admitted patients were taking 2 or more medications. The median of number of medications employed was `r statntxprev$mediana`, IQR of `r  statntxprev$p25` - `r statntxprev$p75`, polypharmacy (use of 5 or more drugs in the same individual) was present in `r polifar`% of the patients (see table 2 and figure 2 of the supplementary material).

```{r tbtxprev}
frectxprev %>%
  select(-total) %>%
  mutate(numporc = paste0(n, ' (', frec, ')' )) %>%
  select(txprevs, numporc) %>%
  flextable() %>%
    # set_caption(caption = 'Drugs received before admission.',
    #           style = 'Table Caption') %>%
    set_header_labels(txprevs = 'Medication',
                      numporc = 'No. (%)') %>%
    align(align = 'center', part = 'header') %>%
    bold(part = 'header') %>%
    set_table_properties(width = 0.6, layout = 'autofit')

```

```{r fnumtxprev}
# , fig.cap='Number of medications used before admission to the hospital.'
numtxprevglob %>%
  ggplot(aes(x = numtxprev, y = frec)) +
  labs(x = 'Number of medications received',
       y = 'Percentage of patients') +
  geom_col(color = 'darkolivegreen4',
           fill = 'darkolivegreen2' )


```

## Clinical presentation {.unnumbered}

```{r bdvarclin}
#Base para sÃƒÂ­ntomas.
# totmuestra <- bdcoving %>%
#   filter(motivoegre %in% c(2,3), rescov1 == 1)%>%
#   select(sintoma1) %>%
#   count %>%
#   pull

bdsintprintxt <- bdcoving %>%
  filter(motivoegre %in% c(2,3), rescov1 == 1) %>%
  select(sintoma1) %>%
  mutate(sintoma1 = as.character(sintoma1)) %>%
  mutate(sintoma1 = ifelse(sintoma1 == '15', NA, sintoma1 )) %>%
  mutate(sintoma1 = ifelse(sintoma1 == '11, 12', '11', sintoma1)) %>%
  na.omit %>%
  mutate(sintoma1 = case_when(sintoma1 == '1' ~ 'Cough',
                              sintoma1 == '2' ~ 'Fever',
                              sintoma1 == '3' ~ 'Headache',
                              sintoma1 == '4' ~ 'Anosmia',
                              sintoma1 == '5' ~ 'Malaise',
                              sintoma1 == '6' ~ 'Dizziness',
                              sintoma1 == '7' ~ 'Muscular weakness',
                              sintoma1 == '8' ~ 'Diarrhea',
                              sintoma1 == '9' ~ 'Ageusia',
                              sintoma1 == '10' ~ 'Rash',
                              sintoma1 == '11' ~ 'Dyspnea',
                              sintoma1 == '12' ~ 'Chest pain',
                              sintoma1 == '13' ~ 'Incapability to move',
                              sintoma1 == '14' ~ 'Sore throat') ) %>%
  pivot_longer(sintoma1, names_to = 'apps', values_to = 'valor') %>%
  group_by(apps, valor) %>%
  summarise(n = n()) %>%
  mutate(apps = 'Symptoms',
         frec = round(n/sum(n)*100, 2), total = sum(n)) %>%
  arrange(desc(frec))

bdsintprin <- bdsintprintxt %>%
  ungroup %>%
  mutate( value = paste0(n, ' (', frec, ')'),
          total = as.character(total)) %>%
  rename(variable = apps,
         faltan = total) %>%
  select(valor, value, faltan)

#Base para variables numÃƒÂƒÃ‚ÂƒÃƒÂ‚Ã‚ÂƒÃƒÂƒÃ‚Â‚ÃƒÂ‚Ã‚Â©ricas.
varclinpres <- c('fc', 'fr', 'temp', 'tas', 'tad', 'sato2', 'sato2sin', 'ltso2', 'score')

bdvarclintxt <- bdcoving %>%
  filter(motivoegre %in% c(2,3), rescov1 == 1)%>%
  select(all_of(varclinpres)) %>%
  mutate(sato2tot = ifelse(is.na(sato2sin), sato2,
                           ifelse(is.na(sato2), sato2sin, sato2)),
         relsatlo2 = ltso2/sato2tot *100) %>%
  select(- c(sato2, ltso2, sato2sin, relsatlo2)) %>% 
  summarise(across(everything(), list(
    faltan = ~sum(is.na(.x)),
    mediana = ~ roundcond(median(.x, na.rm = TRUE)),
    p25 = ~ roundcond(quantile(.x, 0.25, na.rm = TRUE)),
    p75 = ~ roundcond(quantile(.x, 0.75, na.rm = TRUE)),
    min = ~ roundcond(min(.x, na.rm = TRUE)),
    max = ~ roundcond(max(.x, na.rm = TRUE))
  )))%>%
  pivot_longer(cols = everything(),
               names_sep = '_',
               names_to = c('valor', '.value'))%>%
  unite('iqr', c(p25, p75), sep = ' - ') %>%
  unite('range',c(min, max), sep = ' - ' ) %>%
  mutate(valor = case_when(
    valor == 'fc' ~ 'Heart rate',
    valor == 'fr' ~ 'Respiratory rate',
    valor == 'temp' ~ 'Temperature',
    valor == 'tas' ~ 'Systolic pressure',
    valor == 'tad' ~ 'Diastolic pressure',
    valor == 'sato2tot' ~ 'Oxygen saturation',
    valor == 'score' ~ 'Severity score'),
    variable = 'Vitals')

bdvarclin <- bdvarclintxt %>%
  mutate(value = paste0(mediana, ', ', '(', iqr, ') ', '[', range, ']'),
         faltan = as.character(faltan)) %>%
  select(valor, value, faltan)

```

All patients were admitted with clinical diagnosis of Covid-19 pneumonia and an abnormal CAT scan. The first symptom reported and vitals at the moment of admission are summarized in table \@ref(tab:tbvarclin). Fever, malaise and cough were the most frequent initial symptoms. Dyspnea was reported as the first symptom in `r bdsintprintxt$n[4]` patients (`r round(bdsintprintxt$frec[4], 1)`%).

```{r tbvarclin}
bdsintomas <- data.frame(valor = 'First symptom', 
                         value = 'No. (%)',
                         faltan = as.character(totmuestra - bdsintprintxt$total[1]))
bdvitales <- data.frame(valor = 'Vitals',
                        value = 'Median, (IQR) [range]',
                        faltan = '')
bdsintprin$faltan <- NA
bdsintomas %>% bind_rows(bdsintprin,bdvitales, bdvarclin) %>%
  flextable() %>%
      set_caption(caption = 'Clinical features at the moment of  hospital admission',
              style = 'Table Caption') %>%
      set_header_labels(valor = 'Variable',
                        value = 'Value',
                        faltan = 'Missing values') %>%
      align(align = 'center', part = 'header') %>%
      bold(part = 'header') %>%
      bold(i = c(1, 14), j = c(1,2)) %>%
      italic(i = c(1, 14), j = c(1,2)) %>%
      align(j = 3, align = 'center', part = 'body') %>%
      set_table_properties(width = 0.6, layout = 'autofit')

```

```{r bdlabos}
#Base de laboratorios
#load('Rdata/labosvalref.rda')
nomvar <- bdcoving %>% select(where(is.numeric)) %>% names
nomlabos <- nomvar[-c(1:13, 39:40, 51:55)]

bdlabosglobtxt <- bdcoving %>%filter(motivoegre %in% c(2,3) & rescov1 == 1)%>%
  select(all_of(nomlabos))%>%
  mutate(plaq = plaq/1000) %>%
  summarise(across(everything(), list(
    hechos = ~sum(!is.na(.x)),
    mediana = ~ round(median(.x, na.rm = TRUE),2),
    p25 = ~ roundcond(quantile(.x, 0.25, na.rm = TRUE)),
    p75 = ~ roundcond(quantile(.x, 0.75, na.rm = TRUE)),
    min = ~ roundcond(min(.x, na.rm = TRUE)),
    max = ~ roundcond(max(.x, na.rm = TRUE))
  )))%>%
  pivot_longer(cols = everything(),
               names_sep = '_',
               names_to = c('valor', '.value'))%>%
  unite('iqr', c(p25, p75), sep = '-') %>%
  unite('range',c(min, max), sep = '-' ) %>%
 left_join(labosvalref, by = 'valor')

# Para que en la tabla final aparezcan las medianas que estÃƒÂƒÃ‚ÂƒÃƒÂ‚Ã‚Â¡n fuera del rango de normalidad:

bdmedianalabos <- bdlabosglobtxt %>%
  mutate(refmin = as.numeric(str_sub(ref, start = 1, end = str_locate(ref, '-')[,1]-1)),
         refmax = as.numeric(str_sub(ref, start = str_locate(ref, '-')[,1]+1 )) ) %>%
  rowwise() %>%
  mutate(fuera = if_else(between(mediana, refmin, refmax), '', '*')) %>%
  select(valor, fuera)

bdlabosglobtxt <- bdlabosglobtxt %>%
  left_join(bdmedianalabos, by = 'valor')

ferrit <- bdlabosglobtxt %>%
  filter(valor == 'ferrit') %>%
  select(hechos) %>%
  pull
vsg <- bdlabosglobtxt %>%
  filter(valor == 'vsg') %>%
  select(hechos) %>%
  pull
```

Laboratory values on admission are in table \@ref(tab:tblabos). Most patients had a complete blood count, D-dimer, arterial blood gases and a basic metabolic panel ordered. The organ damage markers most commonly employed were aspartate aminotransferase (AST), alanine aminotransferase (ALT) and lactate dehydrogenase (LDH). Inflammation markers such as ferritin and erythrocyte sedimentation rate (ESR) were used in only `r ferrit` and `r vsg` patients respectively. Of note, the medians of monocyte, neutrophils, lymphocytes, d-dimer, fibrinogen, PaO~2~, PaCO~2~, HCO~3~, glucose, calcium, AST, ALT, LDH, gamma-glutamyltranferase, ferritin and ESR were out of the normal range.

```{r tblabos}
#Hay que repartir las bases de acuerdo con el tipo, para darle mÃƒÂƒÃ‚ÂƒÃƒÂ‚Ã‚Â¡s orden
bdlabosglob <- bdlabosglobtxt %>%
  mutate(value = paste0(roundcond(mediana,1), '; ', '(', iqr, ') ', '[', range, ']'),
         hechos = as.character(hechos)) %>%
  select(labtest, hechos, value, ref2, tipo,  fuera)

bdbh <- data.frame(labtest = 'Hemogram',
                        hechos = '',
                        value = '',
                        ref2 = '',
                        tipo = '',
                        fuera = '') %>%
  bind_rows(bdlabosglob[which(bdlabosglob$tipo == 'Hemogram'),])


bdmetpanel <- data.frame(labtest = 'Metabolic panel',
                        hechos = '',
                        value = '',
                        ref2 = '',
                        tipo = '',
                        fuera = '') %>%
  bind_rows(bdlabosglob[which(bdlabosglob$tipo == 'Metabolic panel'),])

bdorgdam <- data.frame(labtest = 'Organ damage markers',
                        hechos = '',
                        value = '',
                        ref2 = '',
                        tipo = '',
                       fuera = '') %>%
  bind_rows(bdlabosglob[which(bdlabosglob$tipo == 'Organ damage marker'),])

bdinflam <- data.frame(labtest = 'Inflammation markers',
                        hechos = '',
                        value = '',
                        ref2 = '',
                        tipo = '',
                       fuera = '') %>%
  bind_rows(bdlabosglob[which(bdlabosglob$tipo == 'Inflammation marker'),])

bdgasom <- data.frame(labtest = 'Arterial blood gases',
                        hechos = '',
                        value = '',
                        ref2 = '',
                        tipo = '',
                      fuera = '') %>%
  bind_rows(bdlabosglob[which(bdlabosglob$tipo == 'Gasometry'),])

bdcoag <- data.frame(labtest = 'Coagulation tests',
                        hechos = '',
                        value = '',
                        ref2 = '',
                        tipo = '',
                     fuera = '') %>%
  bind_rows(bdlabosglob[which(bdlabosglob$tipo == 'Coagulation'),])


  # as_grouped_data(groups = c('tipo')) %>% AÃƒÂƒÃ‚ÂƒÃƒÂ‚Ã‚Â±ade una columna, no conviene
bind_rows(bdbh, bdcoag, bdgasom, bdmetpanel, bdorgdam, bdinflam ) %>%
  select(labtest, hechos, value, ref2, fuera) %>%
  flextable(col_keys = c('labtest', 'hechos', 'value', 'ref2')) %>%
  set_caption(caption = 'Laboratory tests values on admission.',
              style = 'Table Caption') %>%
  set_header_labels(labtest = 'Test',
                    hechos = 'No.',
                    value = 'Values',
                    ref2 = 'reference ranges') %>%
  align(align = 'center', part = 'header') %>%
  bold(part = 'header') %>%
  flextable::footnote(j = 3,
                      part = 'header',
                      value = as_paragraph('Median, (IQR), [range]. The values where the median is out of the reference range are highlighted.'),
                      ref_symbols = 'a') %>%
  bold(i = c(1, 11, 15, 20, 29, 39), j = 1) %>%
  color(j = 3, i = ~ fuera == '*', color = 'red') %>%
  fontsize(part = 'body', size = 10) %>%
  set_table_properties( layout = c('autofit'))

```

## Clinical measures during hospitalization {.unnumbered}

```{r bdstxhosp}
txhospeng <- read_lines('bases-originales/nomtxhospeng.txt')
nomtxhospord <- bdcoving%>%select(starts_with('txhosp'))%>%names

frectxhosptxt <- bdcoving%>%
  filter(motivoegre %in% c(2,3) & rescov1 == 1)%>%
  select(starts_with('txhosp')) %>%
  pivot_longer(starts_with('txhosp'), names_to = 'txhosps', values_to = 'valor')%>%
  group_by(txhosps, valor) %>%
  na.omit %>%
  mutate(txhosps = factor(txhosps, levels = nomtxhospord, labels = txhospeng),
         valor = factor(valor, levels = c(1,2), labels = c('Si', 'No')))%>%
  summarise(n = n())%>%
  mutate(frec = round(n/sum(n)*100, 2), total = sum(n))%>%filter(valor == 'Si')%>%
  arrange(desc(frec))
numtxhosp <- dim(frectxhosptxt)[1]

#facanum estÃƒÂ¡ codificado en tbstxprev
numtxhospglob <- bdcoving %>%
  filter(motivoegre %in% c(2,3) & rescov1 == 1)%>%
  mutate(across(starts_with('txhosp'), facanum) ) %>%
  rowwise()%>%
  mutate(numtxhosp = (length(nomtxhospord)-sum(is.na(c_across(starts_with('txhosp')))))*2 - sum(c_across(starts_with('txhosp')), na.rm = TRUE))%>%
  select(motivoegre, numtxhosp) %>%
  ungroup %>%
  group_by(numtxhosp)%>%
  summarise(n = n()) %>%
  mutate(frec = round(n/sum(n)*100, 2),
         total = sum(n),
         validos = sum(n)- sum(is.na(numtxhosp)))%>%
  select(numtxhosp, n, frec, validos)

dosomastxh <- round(sum(numtxhospglob$frec[-(1:2)]),1)
polifarhosp <- round(sum(numtxhospglob$frec[6:14]),1)

statntxhosp <- bdcoving %>%
  filter(motivoegre %in% c(2,3) & rescov1 == 1)%>%
  mutate(across(starts_with('txhosp'), facanum) ) %>%
  rowwise()%>%
  mutate(numtxhosp = (length(nomtxhospord)-sum(is.na(c_across(starts_with('txhosp')))))*2 - sum(c_across(starts_with('txhosp')), na.rm = TRUE))%>%
  select(numtxhosp) %>%
  ungroup() %>%
  summarise(mediana = median(numtxhosp, na.rm = TRUE ),
            p25 = round(quantile(numtxhosp, 0.25, na.rm = TRUE),1),
            p75 = round(quantile(numtxhosp, 0.75, na.rm = TRUE),1))


```

```{r dblabhosp, results='hide'}
#Código para obtener bdlabdiario, que es un resumen de laboratorios durante la estancia de los pacientes
# load('Rdata/bdcovdiario.rda')

#No incluimos sato2, sato2sin y ltso2
nomlabdiario <- bdcovdiario %>% select(c(21:45, 53:56, 58:61,75:76)) %>% names
nomlabdiario

#Funciones para resumir los labos de cada paciente
mymin <- function(x){
  round(ifelse(sum(is.na(x)) == length(x),NA, min(x, na.rm = TRUE)), 2)
}
mymax <- function(x){
  round(ifelse(all(is.na(x)),NA, max(x, na.rm = TRUE)), 2)
}
mydif <- function(x){
  mimin <- ifelse(length(x)> 1,last(na.omit(x)) - first(na.omit(x)), 0)
  mimin <- ifelse(all(is.na(x)), NA, mimin)
  return(round(mimin, 2))
}

mydifpor <- function(x){
  primero = first(na.omit(x))
  dif <- ifelse(length(x)> 1,last(na.omit(x)) - first(na.omit(x)), 0)
  porc <- ifelse(primero == 0, dif, dif*100/primero)
  return(round(porc, 2))
}

mylast <- function(x){
  last(na.omit(x))
}

bdlabos <- bdcovdiario %>%
  group_by(nss) %>%arrange(fechaest)%>%
  mutate(sato2tot = ifelse(is.na(sato2sin), sato2,
                           ifelse(is.na(sato2), sato2sin, sato2)),
         plaq = plaq/1000) %>%
  select(- c(sato2, ltso2, sato2sin)) %>% 
  summarise(numestudios = n(), across(all_of(c(nomlabdiario, 'sato2tot')),
                                      list(prom = ~ round(mean(.x, na.rm = TRUE),2),
                                           min = ~mymin(.x),
                                           max = ~mymax(.x),
                                           dif = ~mydif(.x),
                                           difpor = ~mydifpor(.x),
                                           ultimo = ~ mylast(.x) )))

bdporlabos <- bdlabos %>%
  pivot_longer(
    cols = -c(nss, numestudios),
    names_to = c('analito', '.value'),
    names_pattern = '(\\w+)_(\\w+)'  #TambiÃƒÂ©n funciona '(.*)_(.*)
  )

#Hacemos el resumen por laboratorio
bdlabosresum <- bdporlabos %>%
  select(analito, numestudios, prom, min, max, ultimo)%>%
  group_by(analito) %>%
  summarise(across(everything(), list(
    faltan = ~sum(is.na(.x)),
    mediana = ~ round(median(.x, na.rm = TRUE), 2),
    p25 = ~ roundcond(quantile(.x, 0.25, na.rm = TRUE)),
    p75 = ~ roundcond(quantile(.x, 0.75, na.rm = TRUE)),
    min = ~ roundcond(min(.x, na.rm = TRUE),2),
    max = ~ roundcond(max(.x, na.rm = TRUE))
  )))
#pasamos al inglÃƒÂ©s, usando el objeto labosvalref.rda
# load('Rdata/labosvalref.rda')
# le cambiamos el nombre a analito y pegamos labosvalref.rda
bdlabosresum <- bdlabosresum %>%
  rename(valor = analito) %>%
  left_join(labosvalref, by = 'valor')

# Para que en la tabla final aparezcan las medianas que estÃƒÂ¡n fuera del rango de normalidad:

bdmedianalabosdi <- bdlabosresum %>%
  mutate(refmin = as.numeric(str_sub(ref, start = 1, end = str_locate(ref, '-')[,1]-1)),
         refmax = as.numeric(str_sub(ref, start = str_locate(ref, '-')[,1]+1 )) ) %>%
  rowwise() %>%
  mutate(fuera = if_else(between(ultimo_mediana, refmin, refmax), '', '*')) %>%
  select(valor, fuera)

#aÃƒÂ±adimos el flag de que estÃƒÂ¡ fuera de rango y damos formato a mediana y prom_min
bdlabosresum <- bdlabosresum %>%
  left_join(bdmedianalabosdi, by = 'valor') %>%
  mutate(prom_mediana = roundcond(prom_mediana),
         ultimo_mediana = roundcond(ultimo_mediana))
 
bdlabosfin <- bdlabosresum %>%
  mutate(mediana = paste0(prom_mediana, '; ', '(', prom_p25, '-', prom_p75, ') ','[', prom_min, '-',
                          prom_max, ']'),
         ultimo = paste0(ultimo_mediana, '; ', '(', ultimo_p25, '-', ultimo_p75, ') ','[', ultimo_min, '-',
                        ultimo_max, ']'),
         prom_faltan = as.character(dim(bdlabos)[1]-prom_faltan)
  ) %>%
  select(labtest, mediana, ultimo, prom_faltan, ref2, fuera, tipo) %>%
  arrange(tipo)

#Para el texto:
medEstud <- bdlabosresum$numestudios_mediana[1]
maxEstud <- bdlabosresum$numestudios_max[1]
minEstud <- bdlabosresum$numestudios_min[1]
p25Estud <- bdlabosresum$numestudios_p25[1]
p75Estud <- bdlabosresum$numestudios_p75[1]
totdiarios <- dim(bdlabos)[1]
```

The drugs employed during hospitalization varied considerably. Enoxaparin was employed in 92.1% of patients, antibiotics in 91% and corticoids in 76.4%. A total of `r numtxhosp` different drugs were used reflecting the lack of a standard of treatment. This trend is also seen in the number of drugs administered per patient. The median of the number of drugs used to treat the disease was `r statntxhosp$mediana[1]`, IQR of `r statntxhosp$p25[1]` - `r statntxhosp$p75[1]`, polypharmacy was used in `r polifarhosp`% of cases. These results are summarised in Table 3 and figure 3 of the supplementary material.

```{r tbtxhosp}
frectxhosptxt %>%
  mutate(nporc = paste0(n, ' (', frec, ')')) %>%
  ungroup %>%
  select(txhosps, nporc ) %>%
  flextable() %>%
  # set_caption('Medication used during hospital stay.',
  #             style = 'Table Caption') %>%
  set_header_labels(txhosps = 'Medication',
                    nporc = 'No. (%)') %>%
  bold( part = 'header') %>%
  #align(align = 'center', part = 'header') # %>%
  footnote(i = 2,
           j = 1,
           value = as_paragraph(('Other than macrolides')),
           ref_symbols = 'a',
           part = 'body') %>%
  set_table_properties(layout = 'autofit')

# ft <-  mk_par(ft, i = 2, j = 'txhosps',
#            value = as_paragraph(txhosps,
#                                 as_chunk('a',
#                                          props = fp_text(vertical.align = 'superscript'))))
```

```{r fnumtxhosp}
# , fig.cap='Number of medications per patient for treating Covid-19 during hospitalization.'
numtxhospglob %>%
  ggplot(aes(x = numtxhosp, y = frec)) +
  labs(x = 'Number of medications received during hospital stay',
       y = 'Percentage of patients') +
  geom_col(color = 'darkolivegreen4',
           fill = 'darkolivegreen2' )


```

A summary of the laboratory tests performed during hospitalization is presented in table \@ref(tab:tblabhosp). The day when a battery of tests was ordered was registered; the column "values of the mean" presents the average of repeated measurements during the whole stay, while the column "values of the last test" reports the average of the last laboratory report before outcome. The median of studies per patient was `r medEstud`, IQR (`r p25Estud`-`r p75Estud`), range [`r minEstud`- `r maxEstud`]. In the last report before outcome, lymphocytes, neutrophils, D-dimer, fibrinogen, ALT, LDH, gamma-glutamyltransferase, ferritin and ESR had median values above the normal range, while monocytes, bicarbonate, PaCO~2~, paO~2~ and calcium were below the reference values.

```{r tblabhosp}

#Hay que repartir las bases de acuerdo con el tipo, para darle mÃƒÂ¡s orden
bdbh <- data.frame(labtest = 'Hemogram',
                   mediana = '',
                   ultimo = '',
                   prom_faltan = '',
                   ref2 = '',
                   fuera = '',
                   tipo = '') %>%
  bind_rows(bdlabosfin[which(bdlabosfin$tipo == 'Hemogram'),])

bdmetpanel <- data.frame(labtest = 'Metabolic panel',
                         mediana = '',
                         ultimo = '',
                         prom_faltan = '',
                         ref2 = '',
                         fuera = '',
                         tipo = '') %>%
  bind_rows(bdlabosfin[which(bdlabosfin$tipo == 'Metabolic panel'),])

bdorgdam <- data.frame(labtest = 'Organ damage markers',
                       mediana = '',
                       ultimo = '',
                       prom_faltan = '',
                       ref2 = '',
                       fuera = '',
                       tipo = '') %>%
  bind_rows(bdlabosfin[which(bdlabosfin$tipo == 'Organ damage marker'),])

bdinflam <- data.frame(labtest = 'Inflammation markers',
                       mediana = '',
                       ultimo = '',
                       prom_faltan = '',
                       ref2 = '',
                       fuera = '',
                       tipo = '') %>%
  bind_rows(bdlabosfin[which(bdlabosfin$tipo == 'Inflammation marker'),])

bdgasom <- data.frame(labtest = 'Arterial blood gases',
                      mediana = '',
                      ultimo = '',
                      prom_faltan = '',
                      ref2 = '',
                      fuera = '',
                      tipo = '') %>%
  bind_rows(bdlabosfin[which(bdlabosfin$tipo == 'Gasometry'| bdlabosfin$tipo == 'Oxymetry'),])

bdcoag <- data.frame(labtest = 'Coagulation tests',
                     mediana = '',
                     ultimo = '',
                     prom_faltan = '',
                     ref2 = '',
                     fuera = '',
                     tipo = '') %>%
  bind_rows(bdlabosfin[which(bdlabosfin$tipo == 'Coagulation'),])

bind_rows(bdbh, bdcoag, bdgasom, bdmetpanel, bdorgdam, bdinflam ) %>%
  flextable(col_keys = c('labtest', 'mediana', 'ultimo', 'prom_faltan', 'ref2')) %>%
  set_caption(caption = 'Laboratory tests values during hospitalization.',
              style = 'Table Caption') %>%
  set_header_labels(labtest = 'Test',
                    mediana = 'Values of the mean',
                    ultimo = 'Values of the last test',
                    prom_faltan = 'No.',
                    ref2 = 'Reference range') %>%
  align(align = 'center', part = 'header') %>%
  bold(part = 'header') %>%
  flextable::footnote(j = 2:3,
                      part = 'header',
                      value = as_paragraph('Median, (IQR), [range]. The values where the median of the last value is out of the reference range are highlighted.'),
                      ref_symbols = 'a') %>%
  flextable::footnote(j = 4,
                      part = 'header',
                      value = as_paragraph('Number of patients to whom the tests were made'),
                      ref_symbols = 'b') %>%
  bold(i = ~ mediana == '', j = 1) %>%
  color(j = 3, i = ~ fuera == '*', color = 'red') %>%
  fontsize(part = 'body', size = 10) %>%
  set_table_properties( layout = c('autofit'))
```

## Analysis of the outcomes {.unnumbered}

```{r mortalidad}
bdresumen2 <- bdcovdiario %>%
  mutate(en_ventnouci = ifelse(lugaring == 1 & ventilador == 1, 'si', 'no')) %>%
  group_by(nss) %>%
  summarise(en_uci = ifelse(any(lugaring == 2), 'si', 'no' ),
            en_vent = ifelse(any(ventilador == 1), 'si', 'no'),
            en_vnoinv = ifelse(any(ventnoinv == 1), 'si', 'no'),
            en_ventnouci = ifelse(any(en_ventnouci == 'si'), 'si', 'no'),
            n_labos = n()
  )

bdcovm <- bdcoving %>%
  filter(motivoegre %in% c(2,3), rescov1 == 1) %>%
  select(nss, fecha, motivoegre, rescov1, ventnoinv, fechalta, tipoing, diasest, diasenf) %>%
  right_join(bdresumen2, by = 'nss') %>%
  mutate(motivoegre = factor(motivoegre))

numort <- as.numeric(table(bdcovm$motivoegre)[2])
propmort <- paste0(round(prop.table(table(bdcovm$motivoegre))[2]*100, 1), '%')

inconf <- binom.confint(sum(bdcovm$motivoegre == 3), length(bdcovm$motivoegre))
ICdepre <- c('inf'= round(inconf[2,5]*100,1), 'sup'= round(inconf[2,6]*100,1))

cerodias <- bdcovm %>%
  filter(fecha == fechalta) %>%
  count %>%
  pull

mordiacero <- bdcovm %>%
  filter(fecha == fechalta) %>%
  select(motivoegre) %>%
  mutate(motivoegre = factor(motivoegre, labels = c('vivos', 'muertos'))) %>%
  pull
nummordiacero <- table(mordiacero)['muertos']
propmordiacero <- round(prop.table(table(mordiacero))['muertos']*100, 1)
summdiasest <- roundcond(summary(bdcovm$diasest))

```

```{r bdoutcomes}
bducivent2 <- bdcovm %>%
  pivot_longer(starts_with('en_'), names_to = 'vars', values_to = 'valor') %>%
  group_by(vars, valor) %>%
  mutate(motivoegre = factor(motivoegre, levels = c(2,3), labels = c('Alive', 'Died')),
         valor = factor(valor, levels = c('si','no'), labels = c('Yes', 'No')))%>%
  na.omit %>%
  summarise(n = n(),
            eshosp = round(median(diasest, na.rm = TRUE),1),
            p25eshosp = round(quantile(diasest, 0.25, na.rm = TRUE), 1),
            p75eshosp = round(quantile(diasest, 0.75, na.rm = TRUE), 1),
            mineshosp = round(min(diasest, na.rm = TRUE),1),
            maxeshosp = round(max(diasest, na.rm = TRUE),1)) %>%
  mutate(frec = round(n/sum(n)*100, 1),
         total = sum(n, na.rm = TRUE))%>%
  na.omit


bducivent_egre2 <- bdcovm %>%
  pivot_longer(starts_with('en_'), names_to = 'vars', values_to = 'valor') %>%
  group_by(motivoegre, vars, valor) %>%
  mutate(motivoegre = factor(motivoegre, levels = c(2,3), labels = c('Alive', 'Died')),
         valor = factor(valor, levels = c('si','no'), labels = c('Yes', 'No')))%>%
  summarise(n = n())%>%
  mutate(frec = round(n/sum(n)*100, 2)) %>%
  pivot_wider(names_from = motivoegre, values_from = c(n, frec)) %>%
  mutate(total = `n_Died` + `n_Alive`,
         pordef = round(`n_Died`/total*100, 1),
         pormejo = round(`n_Alive`/total*100, 1),
         muertos = paste0(str_pad(`n_Died`,4,side = 'right'), '(', pordef, ')'),
         vivos = paste0(str_pad(`n_Alive`,4,side = 'right'), '(', pormejo, ')')) %>%
  na.omit %>%
  left_join(bducivent2, by = c('vars', 'valor')) %>%
  mutate(total = sum(total.x),
         n = paste0(total.x, ' (', frec, ')'),
         dias = paste0(eshosp, '; (',p25eshosp, '-', p75eshosp, ') [', mineshosp, '-', maxeshosp, ']')) %>%
  mutate(vars = case_when(vars == 'en_uci' ~ 'ICU care',
                          vars == 'en_vent' ~ 'Mechanical ventilation',
                          vars == 'en_ventnouci' ~ 'Mechanical ventilation outside ICU',
                          vars == 'en_vnoinv' ~ 'Non invasive ventilation',
                          TRUE ~ vars))

morvmecnouci <- bducivent_egre2 %>%
  filter(vars == 'Mechanical ventilation outside ICU', valor == 'Yes') %>%
  ungroup() %>%
  select(n_Died) %>%
  pull

totvmecnouci <- bducivent_egre2 %>%
  filter(vars == 'Mechanical ventilation outside ICU', valor == 'Yes') %>%
  ungroup() %>%
  select(total.x) %>%
  pull
pmorvmecnouci <- bducivent_egre2 %>%
  filter(vars == 'Mechanical ventilation outside ICU', valor == 'Yes') %>%
  ungroup() %>%
  select(pordef) %>%
  pull

ventmec <- bducivent_egre2 %>%
  filter(str_detect(vars, 'Mechanical'), valor == 'Yes') %>%
  select(total.x) %>%
  pull
ventmec <- sum(ventmec)
```

From the `r totmuestra` patients admitted, `r numort` died, resulting in a mortality rate of `r propmort` [CI~95%~ (`r ICdepre['inf']`-`r ICdepre['sup']`)]. The median length of stay was `r summdiasest['Median']` days, IQR (`r summdiasest[2]`-`r summdiasest[5]`). A total of `r ventmec` patients (`r round(ventmec/totmuestra*100,1)`%) required invasive ventilation. Table 4 in the supplementary material shows mortality and length of stay, according to the level of care and type of ventilatory support. Figure \@ref(fig:fkaplan) is a Kaplan-Meier plot which depicts the survival probability depending on these variables. The worst outcome was seen in patients on mechanical ventilation outside the ICU, `r morvmecnouci` out of `r totvmecnouci` (`r pmorvmecnouci`%). Patients treated in the ICU without ventilatory support showed the best chance of survival.

```{r tboutcomes}
# Hago una dataframe con los resultados globales
bdoutglobal <- bdcovm %>%
  group_by(motivoegre) %>%
  summarise(n = n()) %>%
  mutate(total = sum(n),
         frec = round(n/sum(n)*100, 1)) %>%
  pivot_wider(names_from = motivoegre, values_from = c(n, total, frec)) %>%
  mutate(dias = paste0(summdiasest['Median'], '; (', summdiasest[2], '-',summdiasest[5],
                       ') [', summdiasest[1], '-', summdiasest[6], ']'),
         muertos = paste0(n_3, ' (', frec_3, ')'),
         vivos = paste0(n_2, ' (', frec_2, ')'),
         n = as.character(total_2),
         vars = 'Overall',
         valor = 'Overall') %>%
    select(vars, muertos, n, dias)

#Selecciono las variables
bdoutcome <- bducivent_egre2 %>%
  filter(valor == 'Yes') %>%
  select(vars, muertos, n, dias)

#Hago la flextable
bind_rows(bdoutglobal, bdoutcome) %>%
  flextable() %>%
  set_header_labels(vars = '',
                   muertos = 'Mortality',
                   n = 'Total',
                   dias = 'Days of stay') %>%
  # set_caption(caption = 'Mortality at discharge and duration of hospitalization according to the level of care and ventilatory support.',
  #             style = 'Table Caption') %>%
  align(align = 'center', part = 'header') %>%
  bold(part = 'header') %>%
  flextable::footnote(i = 1, j = 2:3,
                      part = 'header',
                      value = as_paragraph('Number of patients (percentage).'),
                      ref_symbols = 'a') %>%
  flextable::footnote(i = 1, j = 4,
                      part = 'header',
                      value = as_paragraph('Median; (IQR), [range].'),
                      ref_symbols = 'b') %>%
  bold(i = 1:5, j = 1) %>%
  # bold(i = 1, j = 1, part = 'body') %>%
  # merge_h_range(i = 1, j1 = 2, j2 = 3, part = 'header') %>%
  # hline(i = 1, j = 2:3, part = 'header', border = fp_border(color = 'black')) %>%
  # hline_bottom(part = 'header', border = fp_border(color="black", width = 2)) %>%
  fontsize(part = 'body', size = 10) %>%
  set_table_properties( layout = c('autofit'))
 

```

(ref:fkapmey) Survival of hospitalized patients according to the level of care and the need for mechanical ventilation. *Ward*: Patients which did not need ICU and/or mechanical ventilation, the whole stay occurred in the ward. *ICU*: patients which needded intensive care but were not mechanically ventilated. *ICU+vent*: patients admitted in ICU requiring mechanical ventilation. *Ward+vent*: patients mechanically ventilated in the ward.

```{r fkaplan, fig.cap='(ref:fkapmey)'}
dbfitsurv2 <- bdcovm %>%
  mutate(mortucivent = case_when(en_uci == 'si' & en_vent == 'no' ~ 'solouci',
                                 en_uci == 'si' & en_vent == 'si' ~ 'ucivent',
                                 en_uci == 'no' & en_vent == 'si' ~ 'ventnouci',
                                 en_uci == 'no' & en_vent == 'no' ~ 'piso'))
dbfitsurv2[421, 15] <- 'piso'

dbfitsurv2 <- dbfitsurv2 %>%
  mutate(motivoegre = ifelse(motivoegre == 2, 0,1)) %>%
  select(motivoegre, diasest, mortucivent) 

fit2 <- survfit(Surv(diasest, motivoegre) ~ mortucivent, data = dbfitsurv2)

ggsurvplot(fit = fit2, data = dbfitsurv2, conf.int = FALSE,
           ggtheme = theme_get(),
           xlab = 'Time (days)',
           #ylab = 'caca',
           #legend = 'none',
           #surv.median.line = 'hv',
           legend = 'right',
           legend.labs = c('Ward', 'ICU', 'ICU+vent', 'Ward+vent')) 


```

```{r estadgrafs}
bdvivos <- bdcoving %>%
  filter(motivoegre == 2, rescov1 == 1) %>%
  mutate(sato2tot = ifelse(is.na(sato2sin), sato2,
                         ifelse(is.na(sato2), sato2sin, sato2)),
         sato2ajust = sato2tot - ltso2) %>%
  select(edad,sato2ajust, diasest, diasretraso)

bdmuertos <- bdcoving %>%
  filter(motivoegre == 3, rescov1 == 1) %>%
  mutate(sato2tot = ifelse(is.na(sato2sin), sato2,
                         ifelse(is.na(sato2), sato2sin, sato2)),
         sato2ajust = sato2tot - ltso2) %>%
  select(edad,sato2ajust, diasest, diasretraso)

summedadvivos <- summary(bdvivos$edad) 
summedadmuertos <- summary(bdmuertos$edad)
summoxivivos <- summary(bdvivos$sato2ajust)
summoximuertos <- summary(bdmuertos$sato2ajust)
summestvivos <- summary(bdvivos$diasest)
summestmuertos <- summary(bdmuertos$diasest)
summretvivos <- summary(bdvivos$diasretraso)
summretmuertos <- summary(bdmuertos$diasretraso)
  
```

Figure \@ref(fig:fdensidist) shows the smooth density plots for the age, oxygen saturation at the moment of admission, length of stay and the time elapsed between the first symptoms and hospital admission, separated by living status. The distribution of age, oxygen saturation and length of stay was different between survivors and non-survivors, but not for the days of delay between first symptoms and admission. While the median of the age of the survivors was `r summedadvivos['Median']`, IQR (`r summedadvivos[2]`-`r summedadvivos[5]` ), for the deceased was `r summedadmuertos['Median']`, IQR (`r summedadmuertos[2]`-`r summedadmuertos[5]`). The values of oxygen saturation depicted in figure \@ref(fig:fdensidist) were adjusted substracting the amount of oxygen administered (l/min) to the actual oxygen saturation reported, thus reflecting the severity of the disease. The distribution of this variable is more spread in the non-survivors, with a median of `r summoximuertos['Median']`, IQR (`r summoximuertos[2]`-`r summoximuertos[5]`), while the median of survivors was `r summoxivivos['Median']`, IQR (`r summoxivivos[2]`-`r summoxivivos[5]`). The duration of hospital stay was also different between survivors (median `r summestvivos['Median']`, IQR [`r summestvivos[2]`-`r summestvivos[5]`]) and non-survivors (median `r summestmuertos['Median']`, IQR [`r summestmuertos[2]`-`r summestmuertos[5]`]); it is worth noting that `r cerodias` patients stayed less than 24 hours, and from these, `r nummordiacero` (`r propmordiacero`%) died. Finally, the days of delay were similar between survivors and non-survivors, both with a median of `r summretvivos['Median']` days.

```{r fdensidist, fig.cap='Smooth density plots for the age, oxygen saturation at the moment of admission, days of stay and the time elapsed between the first symptoms and the hospital admission, separated by vital status at the moment of discharge.'}
# Variables de oxigenacion
bdoxigenoing <- bdcoving %>%
  filter(motivoegre %in% c(2,3), rescov1 == 1) %>%
  mutate(motivoegre = factor(motivoegre, labels = c('Survived', 'Died'))) %>%
  mutate(sato2tot = ifelse(is.na(sato2sin), sato2,
                           ifelse(is.na(sato2), sato2sin, sato2)),
         sato2ajust = sato2tot - ltso2) %>%
  select(nss, motivoegre, sato2tot, ltso2, sato2ajust ) %>%
  na.omit

groxi <-  bdoxigenoing %>%
ggplot(aes(x = sato2ajust, fill = motivoegre)) +
  labs(x = 'Oxygen saturation',
       y = NULL) +
  geom_density(alpha = 0.5, adjust = 1.5, show.legend = FALSE) 
  # scale_fill_manual(name = 'Vital Status', values = c('darkolivegreen1', 'darkolivegreen3'))
#______________________________________
# Gráfica de densidad de mortalidad por edad
gredad <- bdcoving %>%
  filter(motivoegre %in% c(2,3), rescov1 == 1) %>%
  mutate(motivoegre = factor(motivoegre, labels = c('Survived', 'Died'))) %>%
  ggplot(aes(edad, fill = motivoegre)) +
  labs(x = 'Age in years',
       y = NULL) +
  geom_density(alpha = 0.5, adjust = 1.5, show.legend = FALSE) 
  # scale_fill_manual(name = 'Vital Status', values = c('darkolivegreen1', 'darkolivegreen3'))

grhosp <- bdcoving %>%
  filter(motivoegre %in% c(2,3), rescov1 == 1) %>%
  mutate(motivoegre = factor(motivoegre, labels = c('Survived', 'Died'))) %>%
  ggplot(aes(diasest, fill = motivoegre)) +
  labs(x = 'Days of hospitalization',
       y = NULL) +
  geom_density(alpha = 0.5, adjust = 1, show.legend = FALSE) 
  # scale_fill_manual(name = 'Vital Status', values = c('darkolivegreen1', 'darkolivegreen3'))

grdelay <- bdcoving %>%
  filter(motivoegre %in% c(2,3), rescov1 == 1) %>%
  mutate(motivoegre = factor(motivoegre, labels = c('Survived', 'Died'))) %>%
  filter(fechainisint < fechahosp) %>%
  ggplot(aes(diasretraso, fill = motivoegre)) +
  labs(x = 'Days of delay',
       y = NULL) +
  geom_density(alpha = 0.5, adjust = 1.5) +
  theme(legend.position = c(0.7, 0.6)) +
  scale_fill_discrete(name = NULL) #, values = c('darkolivegreen1', 'darkolivegreen3')

grid.arrange(gredad,groxi, grhosp, grdelay, ncol = 2)

```

# Discussion {.unnumbered}

```{r confints}
N = totmuestra
sobrepeso <- frecapp$n[2]
inconf_sp <- binom.confint(sobrepeso, N)
IC_sp <- c('inf'= round(inconf_sp[2,5]*100,1), 'sup'= round(inconf[2,6]*100,1))

obesidad <- frecapp$n[1]
inconf_ob <- binom.confint(obesidad, N)
IC_ob <- c('inf'= round(inconf_ob[2,5]*100,1), 'sup'= round(inconf_ob[2,6]*100,1))

dm <- frecapp$n[5]
inconf_dm <- binom.confint(dm, N)
IC_dm <- c('inf'= round(inconf_dm[2,5]*100,1), 'sup'= round(inconf_dm[2,6]*100,1))

has <- frecapp$n[3]
inconf_has <- binom.confint(has, N)
IC_has <- c('inf'= round(inconf_has[2,5]*100,1), 'sup'= round(inconf_has[2,6]*100,1))

#Mortalidad en hospitales:
tbmortGlobHosp <- round(prop.table(table(dfmexhosp$STATUS_VITAL))*100,1)

```

```{r dfmexhosp}
roundPorcHosp <- function(x, dec = 1){
  #browser()
  ifelse(trunc(x) == 0,
         ifelse(x%%1 < 0.005,
                format(round(x,3),
                       trim = TRUE),
                format(round(x,2),
                       nsmall = 2,
                       big.mark = ',',
                       trim = TRUE)),
         
         ifelse(x%%1 < 0.001,
                format(round(x),
                       nsmall = 0,
                       big.mark = ',',
                       trim = TRUE),
                format(round(x, dec),
                       nsmall = dec,
                       big.mark = ',',
                       trim = TRUE))         )
}

dfHospSector <- dfmexhosp %>%
  select(SECTOR, STATUS_VITAL) %>%
  group_by(SECTOR) %>%
  summarise(n_hosp = n()) %>%
  mutate(porc_hosp = (n_hosp/sum(n_hosp))*100,
         tothosp = sum(n_hosp))

dfMortSector <- dfmexhosp %>%
  select(SECTOR, STATUS_VITAL) %>%
  group_by(SECTOR, STATUS_VITAL) %>%
  summarise(n_status = n()) %>%
  pivot_wider(names_from = STATUS_VITAL, values_from = n_status) %>%
  left_join(dfHospSector, by = 'SECTOR') %>%
  mutate(mortrate = round(muerto/n_hosp*100, 1),
         SECTOR2 = case_when(SECTOR == 1 ~ 'Red Cross',
                             SECTOR == 2 ~ 'DIF',
                             SECTOR == 3 ~ 'State Hospitals',
                             SECTOR == 4 ~ 'IMSS',
                             SECTOR == 5 ~ 'IMSS-Bienestar',
                             SECTOR == 6 ~ 'ISSSTE',
                             SECTOR == 7 ~ 'Municipal Hospitals',
                             SECTOR == 8 ~ 'PEMEX',
                             SECTOR == 9 ~ 'Private Hospitals',
                             SECTOR == 10 ~ 'SEDENA',
                             SECTOR == 11 ~ 'SEMAR',
                             SECTOR == 12 ~ 'SSA',
                             SECTOR == 13 ~ 'University Hospitals')
         ) %>%
  select(SECTOR2, n_hosp, muerto, porc_hosp, mortrate)


```

Covid-19 is described as a novel coronavirus disease which affects several organs, mainly the lungs. Its clinical presentation varies from asymptomatic to a life-threatening disease which may progress to acute respiratory distress syndrome (ARDS), multiple organ failure (MOF) and death. This work provides a detailed description of the clinical presentation and outcomes in a tertiary Mexican hospital.

As for March 1^st^ 2021, the General Directorate of Epidemiology of the Mexican Ministry of Health (MMH) reported a global mortality of 2.2%; in Mexico, according to the MMH daily technical report on Covid-19, the lethality of the disease is around 9% [@salud2021]. A meta-analysis published in July 2020, reported an overall fatality rate of 6%, but does not give information about the in-hospital mortality rate @pormohammad2020. A recent paper reported some of the features of patients with Covid-19 in Mexico, @parra-bracamonte2020, using the open data source provided by the *Epidemiological Surveillance System of Respiratory Viral Diseases* (ESSRV) of the Mexican government [@informac2021]. We analized the ESSRV database (accessed on March, 2021) and found that around 91% of deaths by Covid-19 occur in hospitals. The overall in-hospital mortality was `r tbmortGlobHosp['muerto']`%. Table 5 in the supplementary material shows hospitalization and mortality rates reported by different sectors of the Mexican Health System, and a considerable difference can be seen among them. It is worth noting that the IMSS received more than 50% of the patients requiring hospitalization in Mexico. These numbers are in contrast with the mortality seen in hospitalized patients in other countries. In a report of 5700 patients admitted to 12 hospitals in the New York City area, a mortality rate of 21% was observed. [@richardson2020]. An initial report of 1590 hospitalized patients in China from 575 hospitals showed an overall mortality rate of 3.2% [@liang2020], while another paper from the RECOVERY Collaborative Group reported 25.7% in 4716 patients from 176 hospitals in the United Kingdom [@group2020].

High body mass index, type II diabetes mellitus (DM) and hypertension are preexisting conditions that have been associated with the severity of disease [@ho2020]. According to the National Survey of Health and Nutrition 2018 [@encuesta2018], in Mexico 75.2% of adults are either overweight or obese (39.1% and 36.1% respectively). The 95% confidence intervals of the frequencies reported in this study include these values, thus reflecting the distribution of these conditions in the general population (CI~95%~ for overweight `r paste0(IC_sp['inf'], '-', IC_sp['sup'])`%, CI~95%~ for obesity `r paste0(IC_ob['inf'], '-', IC_ob['sup'])`%) . This is not the case for diabetes mellitus and hypertension. The aforementioned survey reports a prevalence for DM of 10.3% (9.1% in men and 11.4% for women) and for hypertension of 18.4% (20.9% for women and 15.3% for men). The proportion of DM in the sample is more than two fold the reported in the general population (CI~95%~ for DM `r paste0(IC_dm['inf'], '-', IC_dm['sup'])`%). The prevalence of hypertension was also higher than in the general population (CI~95%~ for hypertension `r paste0(IC_has['inf'], '-', IC_has['sup'])`%).

Laboratory findings overall are in line with what has been reported elsewhere in the literature with the notable exception of an absence of lymphopenia seen in this sample. Inflammatory markers such as D-dimer, ferritin, fibrinogen, CRP and ESR have been shown to be almost universally elevated and may reflect severity [@huang2020; @kermali2020; @zeng2020]. During admission a decrease in some of these inflammatory markers may suggest recovery [@mueller2020]. Lymphopenia has been suggested as predictor of illness severity and recovery, but is unclear if it results from direct viral infection or incidentally in the course of the disease [@liu2020; @he2005]. In contrast, monocytopenia was observed in our patient population and has been reported to be associated specifically in patients with type 2 diabetes [@alzaid2020]. The presence of monocytopenia with absence of lymphopenia in our study is of unclear significance and it may need further research.

Management of severe Covid-19 demands specialized care and the use of considerable resources. Accordingly, treatment options may be limited in low and middle-income countries, leading to an increased mortality. A previous report on hospital mortality in mechanically ventilated Covid-19 patients in Mexico, shows a difference when compared with other countries such as the United Kingdom or Germany [@ñamendys-silva2020], but this was a retrospective study using the ESSRV database. In a prospective observational study by the Mexico COVID-19 Critical Care Collaborative Group, the overall mortality rate observed in 164 patients admitted to ten ICUs was 51.8% @ñamendys-silva2021 . Results presented in this study underline the difference in mortality when patients are mechanically ventilated outside the ICU. In October 2020, the Mexican government issued a set of reccomendations for treatment of hospitalized Covid-19 patients [@secretariadesalud2020]. Recently, the European Respiratory Society published a guideline for the management of hospitalized adults with Covid-19 [@chalmers2021]. In general, the panel reccomends the use of anticoagulation in all hospitalized patients and in cases requiring supplementary oxygen or ventilatory support, the use of systemic corticosteroids, IL-6 receptor antagonist monoclonal antibody, and non-invasive ventilatory support, including high-flow nasal cannula and non-invasive ventilation, when no immediate indication for invasive mechanical ventilation is present.

This work has some limitations. Due to its retrospective nature, some data was not available for all patients. The influence of some variables on the outcome was not analyzed deliberately, as we are working on a different paper to address this associations.

In conclusion, the results presented give a snapshot of the clinical presentation, evolution and clinical outcomes of Covid-19 patients in a representative Mexican hospital. Overweight, obesity, hypertension and diabetes mellitus were the most common comorbid conditions. Fever, malaise and cough were the most common initial symptoms. Monocytopenia rather than lymphopenia was seen in this cohort. The highest mortality rate was seen in patients on mechanical ventilation outside UCI. Future interventions to improve outcomes may be evaluated taking into account these results.

```{r tbMortSector}
dfMortSector %>%
  ungroup %>%
  arrange(desc(porc_hosp)) %>%
  mutate(muerto = roundcond(muerto, 0),
         n_hosp = roundcond(n_hosp, 0),
         porc_hosp = roundPorcHosp(porc_hosp)) %>%
  mutate(n_hosp = paste0(n_hosp, ' (', mortrate, ')')) %>%
  select(SECTOR2, n_hosp, muerto, mortrate) %>%
  # Hacemos la flextable:
  flextable() %>%
    # set_caption('In-hospital mortality rates in Mexico',
    #           style = 'Table Caption') %>%
  set_header_labels(SECTOR2 = 'Health care sector',
                    n_hosp = 'Number of patients admitted (%)',
                    muerto = 'Number of deaths',
                    mortrate = 'Mortality rate (%)') %>%
  bold( part = 'header') %>%
  #align(align = 'center', part = 'header') # %>%
  add_footer_row(values = 'Source: open database of the  Epidemiological Surveillance System of Respiratory Viral Diseases, Ministry of Health, Mexico (accessed 26/03/2021).', colwidths = 4) %>%
  footnote(i = 1,
           j = 2,
           value = as_paragraph('Total of patients hospitalized: ', dfHospSector$tothosp[1], '.'),
           ref_symbols = '1',
           part = 'header') %>%
  footnote(i = 13,
           j = 1,
           value = as_paragraph('Children\'s hospital.'),
           ref_symbols = '2') %>%
  set_table_properties(layout = 'autofit')

    
```

# References {.unnumbered}
